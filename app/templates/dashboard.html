{% extends "home.html" %}
{% block centermain %}

<style>
    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
    }

    .dashboard-title {
        font-size: 22px;
        font-weight: 700;
        margin: 0;
    }

    .create-btn {
        padding: 10px 18px;
        border-radius: 999px;
        background-color: #1d9bf0;
        color: #ffffff;
        font-weight: 600;
        font-size: 14px;
    }

    .create-btn:hover {
        background-color: #1a8cd8;
        text-decoration: none;
    }

    .feed {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .blog-card {
        background-color: #16181c;
        border: 1px solid #2f3336;
        border-radius: 16px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .blog-author {
        font-size: 13px;
        color: #71767b;
    }

    .blog-title {
        font-size: 18px;
        font-weight: 700;
        margin: 0;
    }

    .blog-desc {
        font-size: 14px;
        line-height: 1.6;
    }

    .blog-image {
        max-width: 100%;
        border-radius: 14px;
        border: 1px solid #2f3336;
    }

    .blog-actions {
        display: flex;
        align-items: center;
        gap: 16px;
        font-size: 14px;
    }

    .like-btn {
        background: none;
        border: none;
        color: #e7e9ea;
        cursor: pointer;
        font-size: 15px;
    }

    .like-btn:hover {
        color: #1d9bf0;
    }

    .likes-count {
        color: #71767b;
    }

    .owner-actions {
        margin-top: 8px;
        display: flex;
        gap: 12px;
    }

    .edit-link {
        color: #1d9bf0;
        font-size: 14px;
    }

    .delete-btn {
        background: none;
        border: none;
        color: #f4212e;
        font-size: 14px;
        cursor: pointer;
    }

    .delete-btn:hover {
        text-decoration: underline;
    }
</style>

<section class="dashboard-header">
    <h2 class="dashboard-title">Welcome {{ user.username }}</h2>
    <a href="{{ url_for('home.create_blog') }}" class="create-btn">Create Blog</a>
</section>

<section class="feed">
{% for blog in blogs %}
    <article class="blog-card">
        <div class="blog-author">
            Blog by {{ blog.user.username }}
        </div>

        <h3 class="blog-title">{{ blog.title }}</h3>

        <p class="blog-desc">{{ blog.description }}</p>

        {% if blog.image_path %}
            <img
                src="{{ url_for('static', filename=blog.image_path) }}"
                alt="Blog image"
                class="blog-image"
            >
        {% endif %}

        <div class="blog-actions">
            <button class="like-btn" data-blog-id="{{ blog.id }}">
                {% if blog.id in liked_blog_ids %}
                    ‚ù§Ô∏è Liked
                {% else %}
                    ü§ç Like
                {% endif %}
            </button>

            <span class="likes-count">
                <span id="likes-count-{{ blog.id }}">{{ blog.likes|length }}</span> likes
            </span>
        </div>

        {% if blog.user_id == user.id %}
            <div class="owner-actions">
                <a href="{{ url_for('home.update_blog', blog_id=blog.id) }}" class="edit-link">
                    Edit
                </a>

                <form method="POST"
                      action="{{ url_for('home.delete_blog') }}"
                      onsubmit="return confirm('Are you sure you want to delete this blog?');">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button name="delete" value="{{ blog.id }}" class="delete-btn">
                        Delete
                    </button>
                </form>
            </div>
        {% endif %}
    </article>
{% endfor %}
</section>

<script>
const csrfToken = document
    .querySelector('meta[name="csrf-token"]')
    .getAttribute('content');

document.querySelectorAll(".like-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
        const blogId = btn.dataset.blogId;

        const res = await fetch(`/like/${blogId}`, {
            method: "POST",
            headers: { "X-CSRFToken": csrfToken }
        });

        const data = await res.json();
        document.getElementById(`likes-count-${blogId}`).textContent = data.likes_count;
        btn.textContent = data.liked ? "‚ù§Ô∏è Liked" : "ü§ç Like";
    });
});
</script>

{% endblock %}

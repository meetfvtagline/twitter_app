{% extends "home.html" %}
{% block centermain %}

<h2>Welcome {{ user.username }}</h2>
<a href="{{ url_for('home.create_blog') }}">Create Blog</a>

{% for blog in blogs %}
    <h3>{{ blog.title }}</h3>
    <p>{{ blog.description }}</p>
    {% if blog.image_path %}
        <img src="{{ url_for('static', filename=blog.image_path) }}" width="200">
        <br><br>
    {% endif %}

    <button class="like-btn" data-blog-id="{{ blog.id }}">
        {% if blog.id in liked_blog_ids %}
            ‚ù§Ô∏è Liked
        {% else %}
            ü§ç Like
        {% endif %}
    </button>

    <p>
        <span id="likes-count-{{ blog.id }}">{{ blog.likes|length }}</span> likes
    </p>

    {% if blog.user_id == user.id %}
        <form method="POST" action="{{ url_for('home.delete_blog') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button name="delete" value="{{ blog.id }}">Delete</button>
        </form>
        <a href="{{ url_for('home.update_blog', blog_id=blog.id) }}">Edit</a>
    {% endif %}
{% endfor %}

<script>
const csrfToken = document
    .querySelector('meta[name="csrf-token"]')
    .getAttribute('content');

document.querySelectorAll(".like-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
        const blogId = btn.dataset.blogId;

        const res = await fetch(`/like/${blogId}`, {
            method: "POST",
            headers: { "X-CSRFToken": csrfToken }
        });

        const data = await res.json();
        document.getElementById(`likes-count-${blogId}`).textContent = data.likes_count;
        btn.textContent = data.liked ? "‚ù§Ô∏è Liked" : "ü§ç Like";
    });
});
</script>

{% endblock %}
